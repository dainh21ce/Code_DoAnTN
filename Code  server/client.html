<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ƒêi·ªÅu khi·ªÉn v√† gi√°m s√°t nh√† y·∫øn</title>
  <style>
    /* ==================== C∆† B·∫¢N ==================== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(
        180deg,
        #4CB5F5 0%,
        #B7B8B6 35%,
        #34675C 70%,
        #B3C100 100%
      );
    }

    /* ==================== HEADER ==================== */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      position: relative;
    }

    .page-title {
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      color: #344767;
      letter-spacing: 0.5px;
      flex: 1;
    }

    /* ==================== CONTAINER CH√çNH ==================== */
    .analytics-report {
      max-width: 1400px;
      margin: 8px auto;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
    }

    /* ==================== LAYOUT ==================== */
    .layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .left-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 250px;
    }

    .main-content {
      flex: 1;
      min-width: 0;
    }

    /* ==================== N√öT CHUY·ªÇN T·∫¶NG ==================== */
    .floor-switcher {
      display: flex;
      gap: 10px;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .floor-btn {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .floor-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .floor-btn.active {
      background: white;
      color: #667eea;
      border-color: white;
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
    }

    .floor-btn.active:hover {
      transform: translateY(-2px);
    }

    /* ==================== ƒêI·ªÄU KHI·ªÇN THI·∫æT B·ªä ==================== */
    .device-controls {
      padding: 15px;
      background-color: #cce6e9;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
    }

    .device-controls.active {
      display: block; /* Hi·ªán khi active */
    }

    .device-controls h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 18px;
      color: #333;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.6px;
    }

    .device-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
      padding: 10px 12px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .device-control span {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      flex: 0 1 auto;
      max-width: 70%;
      white-space: normal;
    }

    .toggle-btn {
      flex-shrink: 0;
      width: 90px;
      padding: 7px 0;
      border: none;
      border-radius: 999px;
      background-color: #ced4da;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      transition: background-color 0.3s, transform 0.2s;
    }

    .toggle-btn:hover {
      transform: scale(1.05);
    }

    .toggle-btn.active {
      background-color: #28a745;
    }

    /* ==================== DASHBOARD T·ªîNG QUAN ==================== */
    .dashboard-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
    }

    .stat-card.active {
      display: block; /* Hi·ªán khi active */
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #666;
      font-weight: 700;
    }

    .stat-card p {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    /* ==================== ƒê·ªí TH·ªä ==================== */
    .charts-container {
      margin-bottom: 30px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
    }

    .chart-card {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
    }

    .chart-card.active {
      display: block; /* Hi·ªán khi active */
    }

    .chart-card h4 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: #333;
      text-align: center;
    }

    .chart-container {
      width: 100%;
      height: 350px;
      position: relative;
    }

    /* ==================== B√ÅO C√ÅO ==================== */
    .report-generation {
      margin-bottom: 20px;
    }

    .report-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type="date"] {
      padding: 9px 12px;
      border: 1.5px solid #ced4da;
      border-radius: 7px;
      font-size: 13px;
      transition: border-color 0.3s, box-shadow 0.3s;
      flex: 0 0 auto;
      width: 145px;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    input[type="date"]:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      outline: none;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: background-color 0.3s, transform 0.2s;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .datetime-info {
      margin-left: auto;
      display: flex;
      gap: 15px;
      align-items: center;
      font-size: 13px;
      color: #666;
      white-space: nowrap;
    }

    /* ==================== MENU HAMBURGER ==================== */
    .hamburger-container {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 100;
    }

    .hamburger-btn {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      padding: 0;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .hamburger-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .hamburger-btn:active {
      transform: scale(0.95);
    }

    .hamburger-btn span {
      width: 25px;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .hamburger-btn.active span:nth-child(1) {
      transform: rotate(45deg) translate(7px, 7px);
    }

    .hamburger-btn.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger-btn.active span:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -7px);
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      padding: 15px;
      min-width: 250px;
      z-index: 1000;
      animation: slideDown 0.3s ease;
    }

    .menu-dropdown.show {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-dropdown button {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu-dropdown button:hover {
      transform: translateX(5px);
    }

    #show-weather-btn {
      background: linear-gradient(135deg, #4CB5F5 0%, #667eea 100%);
    }

    #show-weather-btn:hover {
      background: linear-gradient(135deg, #3a9fd8 0%, #5568d3 100%);
    }

    #download-charts {
      background-color: #9c27b0;
    }

    #download-charts:hover {
      background-color: #7b1fa2;
    }

    #show-energy-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #show-energy-btn:hover {
      background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
    }

    #export-excel {
      background-color: #28a745;
    }

    #export-excel:hover {
      background-color: #218838;
    }

    #show-camera-btn {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
    }

    #show-camera-btn:hover {
      background: linear-gradient(135deg, #EE5A52 0%, #FF7643 100%);
    }

    /* ==================== MODAL C∆† B·∫¢N ==================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-content {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 20px;
      padding: 0;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-close {
      background: #dc3545;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.2s;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      transform: scale(1.1);
      background: #c82333;
    }

    /* ==================== MODAL TH·ªúI TI·∫æT ==================== */
    .weather-modal-body {
      padding: 0;
    }

    .weather-hero-card {
      background: linear-gradient(135deg, #5DADE2 0%, #85C1E2 100%);
      padding: 40px 30px;
      text-align: center;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .weather-hero-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 15s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.3; }
    }

    .weather-hero-content {
      position: relative;
      z-index: 1;
    }

    .weather-main-icon {
      font-size: 100px;
      margin: 10px 0;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
    }

    .weather-main-temp {
      font-size: 72px;
      font-weight: 700;
      margin: 15px 0 5px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      letter-spacing: -2px;
    }

    .weather-main-desc {
      font-size: 20px;
      margin: 8px 0;
      opacity: 0.95;
      font-weight: 500;
      text-transform: capitalize;
    }

    .weather-main-location {
      font-size: 16px;
      opacity: 0.9;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .weather-details-section {
      padding: 25px;
      background: #fff;
    }

    .weather-details-grid-new {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .weather-info-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border-left: 4px solid #5DADE2;
      transition: all 0.3s ease;
    }

    .weather-info-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-left-color: #3498db;
    }

    .weather-info-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .weather-info-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .weather-info-value {
      font-size: 22px;
      font-weight: 700;
      color: #2c3e50;
    }

    .weather-footer {
      padding: 15px 25px;
      background: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      font-size: 12px;
      color: #6c757d;
    }

    .weather-footer p {
      margin: 3px 0;
    }

    /* ==================== MODAL ƒêI·ªÜN NƒÇNG ==================== */
    .energy-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 5px solid #667eea;
    }

    .energy-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 18px;
    }

    .energy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .energy-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .energy-item-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .energy-item-value {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
    }

    .config-section {
      background: #fff3cd;
      padding: 20px;
      border-radius: 8px;
      border-left: 5px solid #ffc107;
      margin-bottom: 25px;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .config-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .config-item label {
      font-size: 13px;
      font-weight: bold;
      color: #333;
    }

    .config-item input {
      padding: 8px;
      border: 2px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
    }

    .config-item input:focus {
      border-color: #667eea;
      outline: none;
    }

    .energy-modal-content {
      max-width: 900px;
      padding: 30px;
    }

    .energy-modal-header {
      border-bottom: 3px solid #667eea;
      margin-bottom: 25px;
      padding-bottom: 15px;
    }

    /* ==================== MODAL CAMERA ==================== */
    .camera-modal-body {
      padding: 30px;
    }

    .camera-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .camera-stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      color: white;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .camera-stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 3s ease-in-out infinite;
    }

    .camera-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .camera-stat-card.bird-in {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .camera-stat-card.bird-out {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }

    .camera-stat-card.total-birds {
      background: linear-gradient(135deg, #007bff 0%, #17a2b8 100%);
    }

    .camera-stat-card.counted-birds {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }

    .camera-stat-card.alert {
      background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%);
    }

    .camera-stat-icon {
      font-size: 50px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .camera-stat-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    .camera-stat-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
    }

    .camera-stat-time {
      font-size: 11px;
      opacity: 0.8;
      position: relative;
      z-index: 1;
    }

    .camera-alert-section {
      background: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .camera-alert-section h3 {
      margin: 0 0 15px 0;
      color: #856404;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .camera-alert-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .camera-alert-list::-webkit-scrollbar {
      width: 6px;
    }

    .camera-alert-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .camera-alert-list::-webkit-scrollbar-thumb {
      background: #ffc107;
      border-radius: 10px;
    }

    .camera-alert-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .camera-alert-icon {
      font-size: 30px;
      flex-shrink: 0;
    }

    .camera-alert-content {
      flex: 1;
    }

    .camera-alert-title {
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 5px;
      font-size: 15px;
    }

    .camera-alert-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 3px;
    }

    .camera-alert-time {
      font-size: 11px;
      color: #999;
    }

    .camera-video-section {
      margin-top: 25px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
    }

    .camera-video-section h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* khung iframe / img stream */
    .camera-video-frame {
      width: 100%;
      height: 360px;
      border: none;
      border-radius: 10px;
      background: #000;
    }

    .camera-stream-img {
      width: 100%;
      height: 360px;
      object-fit: cover;
      border-radius: 10px;
      background: #000;
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .camera-controls button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .camera-controls button:hover {
      transform: translateY(-2px);
    }

    .btn-refresh {
      background: #28a745;
      color: white;
    }

    .btn-refresh:hover {
      background: #218838;
    }

    .btn-settings {
      background: #6c757d;
      color: white;
    }

    .btn-settings:hover {
      background: #5a6268;
    }

    .btn-export {
      background: #007bff;
      color: white;
    }

    .btn-export:hover {
      background: #0056b3;
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
      body {
        background-color: #ffffff;
      }

      .page-header {
        margin-bottom: 12px;
      }

      .page-title {
        font-size: 18px;
        padding-right: 60px;
      }

      .analytics-report {
        margin: 0;
        padding: 10px;
        border-radius: 0;
        box-shadow: none;
      }

      .layout {
        flex-direction: column;
        gap: 15px;
      }

      .left-sidebar {
        width: 100%;
        min-width: 100%;
        gap: 15px;
      }

      .floor-switcher {
        padding: 10px;
        gap: 8px;
      }

      .floor-btn {
        padding: 10px 15px;
        font-size: 14px;
      }

      .device-control {
        padding: 8px 10px;
        margin-bottom: 8px;
        gap: 10px;
      }

      .device-control span {
        font-size: 14px;
      }

      .toggle-btn {
        width: 80px;
        font-weight: 700;
        padding: 7px 0;
        font-size: 13px;
      }

      .dashboard-overview {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card {
        padding: 15px 10px;
      }

      .stat-card h3 {
        font-size: 12px;
        margin-bottom: 8px;
      }

      .stat-card p {
        font-size: 20px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .chart-card {
        padding: 15px;
      }

      .chart-card h4 {
        font-size: 16px;
        margin-bottom: 15px;
      }

      .chart-container {
        height: 280px;
      }

      .report-filters {
        flex-direction: column;
        gap: 12px;
      }

      input[type="date"] {
        width: 130px;
        padding: 10px;
        font-size: 14px;
      }

      .datetime-info {
        width: 100%;
        margin-left: 0;
        justify-content: center;
        padding: 12px;
        background-color: #f0f2f5;
        border-radius: 8px;
        font-size: 14px;
        gap: 20px;
      }

      .hamburger-container {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 10001;
      }

      .hamburger-btn {
        width: 45px;
        height: 45px;
      }

      .menu-dropdown {
        min-width: 220px;
      }

      .menu-dropdown button {
        padding: 14px 16px;
        font-size: 16px;
      }

      .modal-content {
        margin: 10px;
        max-width: calc(100% - 20px);
      }

      .weather-details-grid-new {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .weather-main-temp {
        font-size: 60px;
      }

      .weather-main-icon {
        font-size: 80px;
      }

      .weather-hero-card {
        padding: 30px 20px;
      }
      
      .energy-grid {
        grid-template-columns: 1fr;
      }
      
      .config-grid {
        grid-template-columns: 1fr;
      }

      .energy-modal-content {
        padding: 20px;
      }

      .camera-stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .camera-stat-value {
        font-size: 28px;
      }

      .camera-stat-icon {
        font-size: 40px;
      }

      .camera-video-frame,
      .camera-stream-img {
        height: 220px;
      }

      .camera-controls {
        flex-direction: column;
      }

      .camera-controls button {
        width: 100%;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .analytics-report {
        margin: 15px;
        padding: 18px;
      }

      .left-sidebar {
        min-width: 220px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 320px;
      }

      .weather-details-grid-new {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1400px) {
      .analytics-report {
        max-width: 1600px;
      }

      .chart-container {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="analytics-report">
    <div class="page-header">
      <h1 class="page-title">B·∫£ng ƒëi·ªÅu khi·ªÉn &amp; gi√°m s√°t nh√† y·∫øn</h1>
      
      <div class="hamburger-container">
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        
        <div class="menu-dropdown" id="menu-dropdown">
          <button id="show-weather-btn">üå§Ô∏è Th·ªùi ti·∫øt</button>
          <button id="download-charts">üìä T·∫£i ƒë·ªì th·ªã</button>
          <button id="show-energy-btn">‚ö° ƒêi·ªán nƒÉng</button>
          <button id="export-excel">üì• Xu·∫•t Excel</button>
          <button id="show-camera-btn">üìπ Camera</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- ==================== SIDEBAR ƒêI·ªÄU KHI·ªÇN ==================== -->
      <div class="left-sidebar">
        <!-- N√öT CHUY·ªÇN T·∫¶NG -->
        <div class="floor-switcher">
          <button class="floor-btn active" data-floor="1">
            üè¢ T·∫ßng 1
          </button>
          <button class="floor-btn" data-floor="2">
            üè¢ T·∫ßng 2
          </button>
        </div>

        <!-- ƒêI·ªÄU KHI·ªÇN T·∫¶NG 1 -->
        <div class="device-controls active" data-floor-controls="1">
          <h3>ƒêi·ªÅu khi·ªÉn T·∫ßng 1</h3>
          <div class="device-control">
            <span>LED</span>
            <button class="toggle-btn toggle-led1" data-device="led" data-floor="1">OFF</button>
          </div>
          <div class="device-control">
            <span>Qu·∫°t</span>
            <button class="toggle-btn toggle-fan1" data-device="fan" data-floor="1">OFF</button>
          </div>
          <div class="device-control">
            <span>S∆∞·ªüi</span>
            <button class="toggle-btn toggle-heater1" data-device="heater" data-floor="1">OFF</button>
          </div>
          <div class="device-control">
            <span>Phun s∆∞∆°ng</span>
            <button class="toggle-btn toggle-fog1" data-device="fog" data-floor="1">OFF</button>
          </div>
        </div>

        <!-- ƒêI·ªÄU KHI·ªÇN T·∫¶NG 2 -->
        <div class="device-controls" data-floor-controls="2">
          <h3>ƒêi·ªÅu khi·ªÉn T·∫ßng 2</h3>
          <div class="device-control">
            <span>LED</span>
            <button class="toggle-btn toggle-led2" data-device="led" data-floor="2">OFF</button>
          </div>
          <div class="device-control">
            <span>Qu·∫°t</span>
            <button class="toggle-btn toggle-fan2" data-device="fan" data-floor="2">OFF</button>
          </div>
          <div class="device-control">
            <span>S∆∞·ªüi</span>
            <button class="toggle-btn toggle-heater2" data-device="heater" data-floor="2">OFF</button>
          </div>
          <div class="device-control">
            <span>Phun s∆∞∆°ng</span>
            <button class="toggle-btn toggle-fog2" data-device="fog" data-floor="2">OFF</button>
          </div>
        </div>
      </div>

      <!-- ==================== N·ªòI DUNG CH√çNH ==================== -->
      <div class="main-content">
        <div class="dashboard-overview">
          <!-- T·∫¶NG 1 -->
          <div class="stat-card active" data-floor-stat="1">
            <h3>Nhi·ªát ƒë·ªô T·∫ßng 1</h3>
            <p id="temp-floor1">--¬∞C</p>
          </div>
          <div class="stat-card active" data-floor-stat="1">
            <h3>ƒê·ªô ·∫©m T·∫ßng 1</h3>
            <p id="hum-floor1">--%</p>
          </div>
          
          <!-- T·∫¶NG 2 -->
          <div class="stat-card" data-floor-stat="2">
            <h3>Nhi·ªát ƒë·ªô T·∫ßng 2</h3>
            <p id="temp-floor2">--¬∞C</p>
          </div>
          <div class="stat-card" data-floor-stat="2">
            <h3>ƒê·ªô ·∫©m T·∫ßng 2</h3>
            <p id="hum-floor2">--%</p>
          </div>
        </div>

        <div class="charts-container">
          <div class="charts-grid">
            <!-- ƒê·ªí TH·ªä T·∫¶NG 1 -->
            <div class="chart-card active" data-floor-chart="1">
              <h4>üìä T·∫ßng 1 - Nhi·ªát ƒë·ªô v√† ƒê·ªô ·∫©m</h4>
              <div class="chart-container">
                <canvas id="chart-floor1"></canvas>
              </div>
            </div>

            <!-- ƒê·ªí TH·ªä T·∫¶NG 2 -->
            <div class="chart-card" data-floor-chart="2">
              <h4>üìä T·∫ßng 2 - Nhi·ªát ƒë·ªô v√† ƒê·ªô ·∫©m</h4>
              <div class="chart-container">
                <canvas id="chart-floor2"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="report-generation">
          <div class="report-filters">
            <input type="date" id="start-date" />
            
            <div class="datetime-info">
              <span id="current-time">--:--:--</span>
              <span id="current-date">--/--/----</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ==================== C·∫§U H√åNH SERVER & API ====================
    const SERVER_URL = window.location.origin;
    const POLLING_INTERVAL = 3000;

    // ==================== C·∫§U H√åNH ESP32-CAM ====================
    // ƒê·ªîI IP N√ÄY TH√ÄNH IP C·ª¶A ESP32-CAM (in tr√™n Serial Monitor)
    const CAMERA_WEB_URL = 'http://172.20.10.14';          // v√≠ d·ª•
    const CAMERA_STREAM_URL = CAMERA_WEB_URL + ':81/stream'; // d√πng n·∫øu mu·ªën <img> stream

    const WEATHER_API_KEY = 'cd7ae1be38555eb75cba7cc6463b7838';
    const WEATHER_CITY = 'Da Nang';
    const WEATHER_COUNTRY = 'VN';
    const WEATHER_UPDATE_INTERVAL = 600000;

    // ==================== BI·∫æN TO√ÄN C·ª§C ====================
    let weatherData = null;
    let energyData = null;
    let lastDataCheck = Date.now();
    let currentFloor = 1; // T·∫ßng hi·ªán t·∫°i ƒëang hi·ªÉn th·ªã

    const tempPoints1 = [];
    const humPoints1  = [];
    const tempPoints2 = [];
    const humPoints2  = [];

    const WEATHER_ICONS = {
      '01d': '‚òÄÔ∏è', '01n': 'üåô',
      '02d': '‚õÖ', '02n': '‚òÅÔ∏è',
      '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è',
      '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è',
      '09d': 'üåßÔ∏è', '09n': 'üåßÔ∏è',
      '10d': 'üå¶Ô∏è', '10n': 'üåßÔ∏è',
      '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è',
      '13d': '‚ùÑÔ∏è', '13n': '‚ùÑÔ∏è',
      '50d': 'üå´Ô∏è', '50n': 'üå´Ô∏è'
    };

    const WEATHER_TRANSLATIONS = {
      'clear sky': 'Tr·ªùi quang ƒë√£ng',
      'few clouds': '√çt m√¢y',
      'scattered clouds': 'M√¢y r·∫£i r√°c',
      'broken clouds': 'Nhi·ªÅu m√¢y',
      'overcast clouds': 'U √°m',
      'shower rain': 'M∆∞a r√†o',
      'rain': 'M∆∞a',
      'light rain': 'M∆∞a nh·∫π',
      'moderate rain': 'M∆∞a v·ª´a',
      'heavy rain': 'M∆∞a n·∫∑ng h·∫°t',
      'thunderstorm': 'Gi√¥ng b√£o',
      'snow': 'Tuy·∫øt',
      'mist': 'S∆∞∆°ng m√π',
      'smoke': 'Kh√≥i',
      'haze': 'S∆∞∆°ng m√π nh·∫π',
      'fog': 'S∆∞∆°ng m√π d√†y ƒë·∫∑c'
    };

    // ==================== H·ªÜ TH·ªêNG CAMERA (LOGIC GI·∫¢ L·∫¨P) ====================
    let cameraData = {
      birdIn: 0,
      birdOut: 0,
      totalBirds: 150,
      countedBirds: 150,
      alerts: [
        {
          id: 1,
          type: 'Chim l·∫° ph√°t hi·ªán',
          description: 'Ph√°t hi·ªán 1 chim kh√¥ng thu·ªôc ƒë√†n',
          time: new Date(Date.now() - 5 * 60000).toLocaleString('vi-VN'),
          severity: 'high'
        },
        {
          id: 2,
          type: 'Chim l·∫° ph√°t hi·ªán',
          description: 'Ph√°t hi·ªán chim sƒÉn m·ªìi ti·∫øp c·∫≠n',
          time: new Date(Date.now() - 15 * 60000).toLocaleString('vi-VN'),
          severity: 'critical'
        },
        {
          id: 3,
          type: 'Ho·∫°t ƒë·ªông b·∫•t th∆∞·ªùng',
          description: 'S·ªë l∆∞·ª£ng chim v√†o gi·∫£m ƒë·ªôt ng·ªôt',
          time: new Date(Date.now() - 30 * 60000).toLocaleString('vi-VN'),
          severity: 'medium'
        }
      ],
      lastUpdate: new Date()
    };

    // ==================== H√ÄM CHUY·ªÇN T·∫¶NG ====================
    function switchFloor(floor) {
      currentFloor = floor;
      
      document.querySelectorAll('.floor-btn').forEach(btn => {
        if (parseInt(btn.dataset.floor) === floor) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      document.querySelectorAll('[data-floor-controls]').forEach(control => {
        if (parseInt(control.dataset.floorControls) === floor) {
          control.classList.add('active');
        } else {
          control.classList.remove('active');
        }
      });
      
      document.querySelectorAll('[data-floor-stat]').forEach(stat => {
        if (parseInt(stat.dataset.floorStat) === floor) {
          stat.classList.add('active');
        } else {
          stat.classList.remove('active');
        }
      });
      
      document.querySelectorAll('[data-floor-chart]').forEach(chart => {
        if (parseInt(chart.dataset.floorChart) === floor) {
          chart.classList.add('active');
        } else {
          chart.classList.remove('active');
        }
      });
      
      console.log(`üîÑ ƒê√£ chuy·ªÉn sang T·∫ßng ${floor}`);
    }

    // ==================== H√ÄM X·ª¨ L√ù NG√ÄY GI·ªú ====================
    function updateDateTime() {
      const now = new Date();
      const timeFormatted = now.toLocaleTimeString('vi-VN', { 
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      const dateFormatted = now.toLocaleDateString('vi-VN', { 
        day: '2-digit', month: '2-digit', year: 'numeric'
      });
      document.getElementById('current-time').textContent = timeFormatted;
      document.getElementById('current-date').textContent = dateFormatted;
    }

    // ==================== H√ÄM X·ª¨ L√ù BI·ªÇU ƒê·ªí ====================
    function calculateScale(dataPoints, isTemperature = false) {
      if (dataPoints.length === 0) {
        return isTemperature ? { min: 0, max: 50 } : { min: 0, max: 100 };
      }

      const values = dataPoints.map(p => p.y).filter(v => v > 0);
      if (values.length === 0) {
        return isTemperature ? { min: 0, max: 50 } : { min: 0, max: 100 };
      }

      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min;

      const buffer = range * 0.1 || (isTemperature ? 5 : 10);
      
      let newMin = Math.floor(min - buffer);
      let newMax = Math.ceil(max + buffer);

      if (newMin < 0) newMin = 0;

      if (isTemperature) {
        newMin = Math.floor(newMin / 5) * 5;
        newMax = Math.ceil(newMax / 5) * 5;
      } else {
        newMin = Math.floor(newMin / 10) * 10;
        newMax = Math.ceil(newMax / 10) * 10;
      }

      return { min: newMin, max: newMax };
    }

    function updateChartScale(chart, tempPoints, humPoints) {
      const tempScale = calculateScale(tempPoints, true);
      const humScale = calculateScale(humPoints, false);

      const min = Math.min(tempScale.min, humScale.min);
      const max = Math.max(tempScale.max, humScale.max);

      chart.options.scales.y.min = min;
      chart.options.scales.y.max = max;
    }

    // ==================== KH·ªûI T·∫†O BI·ªÇU ƒê·ªí ====================
    const ctx1 = document.getElementById('chart-floor1').getContext('2d');
    const chart1 = new Chart(ctx1, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Nhi·ªát ƒë·ªô (¬∞C)',
          data: tempPoints1,
          parsing: false,
          backgroundColor: 'rgba(255, 99, 132, 0.1)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 6,
          yAxisID: 'y'
        }, {
          label: 'ƒê·ªô ·∫©m (%)',
          data: humPoints1,
          parsing: false,
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 6,
          yAxisID: 'y'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              title: (context) => {
                const hour = context[0].parsed.x.toFixed(2);
                return `Gi·ªù: ${hour}`;
              },
              label: (context) => {
                const label = context.dataset.label || '';
                const value = context.parsed.y.toFixed(1);
                return `${label}: ${value}`;
              }
            }
          }
        },
        scales: {
          y: {
            display: true,
            position: 'left',
            title: { display: true, text: 'Nhi·ªát ƒë·ªô (¬∞C) / ƒê·ªô ·∫©m (%)' },
            beginAtZero: false,
            min: 0,
            max: 100,
            ticks: { stepSize: 5 }
          },
          x: {
            type: 'linear',
            min: 0,
            max: 23,
            title: { display: true, text: 'Gi·ªù trong ng√†y (0‚Äì23)' },
            ticks: {
              stepSize: 1,
              callback: (value) => value.toString()
            }
          }
        }
      }
    });

    const ctx2 = document.getElementById('chart-floor2').getContext('2d');
    const chart2 = new Chart(ctx2, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Nhi·ªát ƒë·ªô (¬∞C)',
          data: tempPoints2,
          parsing: false,
          backgroundColor: 'rgba(255, 159, 64, 0.1)',
          borderColor: 'rgba(255, 159, 64, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 6,
          yAxisID: 'y'
        }, {
          label: 'ƒê·ªô ·∫©m (%)',
          data: humPoints2,
          parsing: false,
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 6,
          yAxisID: 'y'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              title: (context) => {
                const hour = context[0].parsed.x.toFixed(2);
                return `Gi·ªù: ${hour}`;
              },
              label: (context) => {
                const label = context.dataset.label || '';
                const value = context.parsed.y.toFixed(1);
                return `${label}: ${value}`;
              }
            }
          }
        },
        scales: {
          y: {
            display: true,
            position: 'left',
            title: { display: true, text: 'Nhi·ªát ƒë·ªô (¬∞C) / ƒê·ªô ·∫©m (%)' },
            beginAtZero: false,
            min: 0,
            max: 100,
            ticks: { stepSize: 5 }
          },
          x: {
            type: 'linear',
            min: 0,
            max: 23,
            title: { display: true, text: 'Gi·ªù trong ng√†y (0‚Äì23)' },
            ticks: {
              stepSize: 1,
              callback: (value) => value.toString()
            }
          }
        }
      }
    });

    // ==================== H√ÄM X·ª¨ L√ù TR·∫†NG TH√ÅI THI·∫æT B·ªä ====================
    function setToggleState(btn, state) {
      if (!btn) return;
      const isOn = (state || 'OFF').toUpperCase() === 'ON';
      if (isOn) {
        btn.classList.add('active');
        btn.textContent = 'ON';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'OFF';
      }
    }

    // ==================== H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ª™ SERVER ====================
   function loadHistory(floor) {
  // floor server c·∫ßn 'floor1' ho·∫∑c 'floor2', kh√¥ng ph·∫£i '1' ho·∫∑c '2'
  const floorKey = floor === 1 ? 'floor1' : 'floor2';

  fetch(`${SERVER_URL}/history/${floorKey}`)
    .then(res => res.json())
    .then(data => {
      console.log(`üìö History Floor ${floorKey} loaded:`, data.count, "records");
      
      if (data.data && data.data.length > 0) {
        const tempPoints = floor === 1 ? tempPoints1 : tempPoints2;
        const humPoints  = floor === 1 ? humPoints1  : humPoints2;
        const chart      = floor === 1 ? chart1      : chart2;
        
        tempPoints.length = 0;
        humPoints.length  = 0;
        
        data.data.forEach(record => {
          const timestamp = new Date(record.timestamp);
          const hourFloat = timestamp.getHours() + timestamp.getMinutes()/60 + timestamp.getSeconds()/3600;
          
          tempPoints.push({ x: hourFloat, y: record.temperature });
          humPoints.push({ x: hourFloat, y: record.humidity });
        });
        
        updateChartScale(chart, tempPoints, humPoints);
        chart.update();
      }
    })
    .catch(err => console.log(`‚ùå Error loading history floor ${floorKey}:`, err));
}

    function fetchStats() {
      fetch(`${SERVER_URL}/stats`)
        .then(res => res.json())
        .then(data => {
          console.log("üìä Stats updated:", data);
        })
        .catch(err => console.log("‚ùå Error fetching stats:", err));
    }

    function fetchData() {
      fetch(`${SERVER_URL}/data`)
        .then(res => res.json())
        .then(data => {
          console.log("üì° Data received:", data);

          if (data.floor1) {
            document.getElementById('temp-floor1').textContent = `${data.floor1.temp}¬∞C`;
            document.getElementById('hum-floor1').textContent = `${data.floor1.hum}%`;

            setToggleState(document.querySelector('.toggle-led1'), data.floor1.led);
            setToggleState(document.querySelector('.toggle-fan1'), data.floor1.fan);
            setToggleState(document.querySelector('.toggle-fog1'), data.floor1.fog);
            setToggleState(document.querySelector('.toggle-heater1'), data.floor1.heater);

            const t1 = parseFloat(data.floor1.temp);
            const h1 = parseFloat(data.floor1.hum);
            if (!isNaN(t1) && !isNaN(h1) && t1 > 0 && h1 > 0) {
              const now = new Date();
              const hourFloat = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;

              const lastPoint = tempPoints1[tempPoints1.length - 1];
              if (!lastPoint || Math.abs(lastPoint.y - t1) > 0.01 || Math.abs(lastPoint.x - hourFloat) > 0.001) {
                tempPoints1.push({ x: hourFloat, y: t1 });
                humPoints1.push({ x: hourFloat, y: h1 });
                
                updateChartScale(chart1, tempPoints1, humPoints1);
                chart1.update();
              }
            }
          }

          if (data.floor2) {
            document.getElementById('temp-floor2').textContent = `${data.floor2.temp}¬∞C`;
            document.getElementById('hum-floor2').textContent = `${data.floor2.hum}%`;

            setToggleState(document.querySelector('.toggle-led2'), data.floor2.led);
            setToggleState(document.querySelector('.toggle-fan2'), data.floor2.fan);
            setToggleState(document.querySelector('.toggle-fog2'), data.floor2.fog);
            setToggleState(document.querySelector('.toggle-heater2'), data.floor2.heater);

            const t2 = parseFloat(data.floor2.temp);
            const h2 = parseFloat(data.floor2.hum);
            if (!isNaN(t2) && !isNaN(h2) && t2 > 0 && h2 > 0) {
              const now = new Date();
              const hourFloat = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;

              const lastPoint = tempPoints2[tempPoints2.length - 1];
              if (!lastPoint || Math.abs(lastPoint.y - t2) > 0.01 || Math.abs(lastPoint.x - hourFloat) > 0.001) {
                tempPoints2.push({ x: hourFloat, y: t2 });
                humPoints2.push({ x: hourFloat, y: h2 });
                
                updateChartScale(chart2, tempPoints2, humPoints2);
                chart2.update();
              }
            }
          }

          lastDataCheck = Date.now();
        })
        .catch(err => console.log("‚ùå Error:", err));
    }

    // ==================== TH·ªúI TI·∫æT ====================
    async function fetchWeather() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_CITY},${WEATHER_COUNTRY}&appid=${WEATHER_API_KEY}&units=metric&lang=vi`;
        
        const response = await fetch(url);
        weatherData = await response.json();
        
        if (weatherData.cod === 200) {
          console.log('üå§Ô∏è Weather updated:', weatherData);
        } else {
          console.error('‚ùå Weather API error:', weatherData);
        }
      } catch (error) {
        console.error('‚ùå Weather fetch error:', error);
      }
    }

    function showWeatherModal() {
      if (!weatherData || weatherData.cod !== 200) {
        alert('ƒêang t·∫£i d·ªØ li·ªáu th·ªùi ti·∫øt...');
        fetchWeather();
        return;
      }

      const iconCode = weatherData.weather[0].icon;
      const weatherIcon = WEATHER_ICONS[iconCode] || 'üå§Ô∏è';
      
      let description = weatherData.weather[0].description;
      description = WEATHER_TRANSLATIONS[description.toLowerCase()] || description;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'weather-modal';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2>‚òÄÔ∏è Th√¥ng tin th·ªùi ti·∫øt</h2>
            <button class="modal-close" onclick="closeWeatherModal()">√ó</button>
          </div>

          <div class="weather-modal-body">
            <div class="weather-hero-card">
              <div class="weather-hero-content">
                <div class="weather-main-icon">${weatherIcon}</div>
                <div class="weather-main-temp">${Math.round(weatherData.main.temp)}¬∞C</div>
                <div class="weather-main-desc">${description}</div>
                <div class="weather-main-location">
                  üìç ${weatherData.name}, ${weatherData.sys.country}
                </div>
              </div>
            </div>

            <div class="weather-details-section">
              <div class="weather-details-grid-new">
                <div class="weather-info-item">
                  <div class="weather-info-icon">üå°Ô∏è</div>
                  <div class="weather-info-label">C·∫£m gi√°c</div>
                  <div class="weather-info-value">${Math.round(weatherData.main.feels_like)}¬∞C</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üíß</div>
                  <div class="weather-info-label">ƒê·ªô ·∫©m</div>
                  <div class="weather-info-value">${weatherData.main.humidity}%</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üí®</div>
                  <div class="weather-info-label">T·ªëc ƒë·ªô gi√≥</div>
                  <div class="weather-info-value">${weatherData.wind.speed.toFixed(1)} m/s</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üìä</div>
                  <div class="weather-info-label">√Åp su·∫•t</div>
                  <div class="weather-info-value">${weatherData.main.pressure} hPa</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üå°Ô∏è</div>
                  <div class="weather-info-label">Nhi·ªát ƒë·ªô min</div>
                  <div class="weather-info-value">${Math.round(weatherData.main.temp_min)}¬∞C</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üå°Ô∏è</div>
                  <div class="weather-info-label">Nhi·ªát ƒë·ªô max</div>
                  <div class="weather-info-value">${Math.round(weatherData.main.temp_max)}¬∞C</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üëÅÔ∏è</div>
                  <div class="weather-info-label">T·∫ßm nh√¨n</div>
                  <div class="weather-info-value">${(weatherData.visibility / 1000).toFixed(1)} km</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">‚òÅÔ∏è</div>
                  <div class="weather-info-label">M√¢y che ph·ªß</div>
                  <div class="weather-info-value">${weatherData.clouds.all}%</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üåÖ</div>
                  <div class="weather-info-label">M·∫∑t tr·ªùi m·ªçc</div>
                  <div class="weather-info-value">${new Date(weatherData.sys.sunrise * 1000).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}</div>
                </div>

                <div class="weather-info-item">
                  <div class="weather-info-icon">üåá</div>
                  <div class="weather-info-label">M·∫∑t tr·ªùi l·∫∑n</div>
                  <div class="weather-info-value">${new Date(weatherData.sys.sunset * 1000).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}</div>
                </div>
              </div>
            </div>

            <div class="weather-footer">
              <p><strong>D·ªØ li·ªáu t·ª´ OpenWeatherMap</strong></p>
              <p>C·∫≠p nh·∫≠t: ${new Date().toLocaleString('vi-VN')}</p>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'block';
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeWeatherModal();
        }
      });
    }

    function closeWeatherModal() {
      const modal = document.getElementById('weather-modal');
      if (modal) {
        modal.remove();
      }
    }

    // ==================== ƒêI·ªÜN NƒÇNG ====================
    async function fetchEnergyReport() {
      try {
        const res = await fetch(`${SERVER_URL}/energy-report`);
        energyData = await res.json();
        console.log('‚ö° Energy report updated:', energyData);
      } catch (error) {
        console.error('‚ùå Error fetching energy report:', error);
      }
    }

    function showEnergyDetail() {
      if (!energyData) {
        alert('ƒêang t·∫£i d·ªØ li·ªáu...');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'energy-modal';
      
      modal.innerHTML = `
        <div class="modal-content energy-modal-content">
          <div class="modal-header energy-modal-header">
            <h2 style="margin: 0; color: #667eea;">‚ö° B√°o c√°o ƒëi·ªán nƒÉng chi ti·∫øt</h2>
            <button class="modal-close" onclick="closeEnergyModal()">√ó</button>
          </div>
          
          <div class="config-section">
            <h3 style="margin: 0 0 10px 0; color: #856404;">‚öôÔ∏è C·∫•u h√¨nh c√¥ng su·∫•t & gi√° ƒëi·ªán</h3>
            <div class="config-grid">
              <div class="config-item">
                <label>LED (W):</label>
                <input type="number" id="power-led" value="${energyData.devicePower.led}" min="0" step="1">
              </div>
              <div class="config-item">
                <label>Qu·∫°t (W):</label>
                <input type="number" id="power-fan" value="${energyData.devicePower.fan}" min="0" step="1">
              </div>
              <div class="config-item">
                <label>Phun s∆∞∆°ng (W):</label>
                <input type="number" id="power-fog" value="${energyData.devicePower.fog}" min="0" step="1">
              </div>
              <div class="config-item">
                <label>S∆∞·ªüi (W):</label>
                <input type="number" id="power-heater" value="${energyData.devicePower.heater}" min="0" step="1">
              </div>
              <div class="config-item">
                <label>Gi√° ƒëi·ªán (‚Ç´/kWh):</label>
                <input type="number" id="electricity-price" value="${energyData.electricityPrice}" min="0" step="100">
              </div>
            </div>
            <button onclick="updateEnergyConfig()" style="margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
              üíæ L∆∞u c·∫•u h√¨nh
            </button>
          </div>
          
          <div class="energy-section" style="border-left-color: #28a745;">
            <h3>üìä T·ªïng h·ª£p (2 t·∫ßng)</h3>
            <div class="energy-grid">
              <div class="energy-item">
                <div class="energy-item-label">ƒêi·ªán ti√™u th·ª• h√¥m nay</div>
                <div class="energy-item-value" style="color: #dc3545;">${energyData.total.daily.totalEnergyKWh} kWh</div>
              </div>
              <div class="energy-item">
                <div class="energy-item-label">Chi ph√≠ h√¥m nay</div>
                <div class="energy-item-value" style="color: #28a745;">${energyData.total.daily.totalCostFormatted}</div>
              </div>
              <div class="energy-item">
                <div class="energy-item-label">∆Ø·ªõc t√≠nh th√°ng (√ó30)</div>
                <div class="energy-item-value" style="color: #ff9800;">${energyData.total.monthly.estimatedEnergyKWh} kWh</div>
              </div>
              <div class="energy-item">
                <div class="energy-item-label">Chi ph√≠ th√°ng ∆∞·ªõc t√≠nh</div>
                <div class="energy-item-value" style="color: #007bff;">${energyData.total.monthly.estimatedCostFormatted}</div>
              </div>
            </div>
          </div>
          
          <div class="energy-section" style="border-left-color: #1976d2;">
            <h3>üè¢ T·∫ßng 1</h3>
            ${generateFloorEnergyHTML(energyData.floor1, 1)}
          </div>
          
          <div class="energy-section" style="border-left-color: #f57c00;">
            <h3>üè¢ T·∫ßng 2</h3>
            ${generateFloorEnergyHTML(energyData.floor2, 2)}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'block';

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeEnergyModal();
        }
      });
    }

    function generateFloorEnergyHTML(floorData, floorNum) {
      let html = `
        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px;">
          <strong>T·ªïng h√¥m nay:</strong> ${floorData.daily.totalEnergyKWh} kWh = ${floorData.daily.totalCostFormatted}<br>
          <strong>∆Ø·ªõc t√≠nh th√°ng:</strong> ${floorData.monthly.estimatedEnergyKWh} kWh = ${floorData.monthly.estimatedCostFormatted}
        </div>
        <div class="energy-grid">
      `;
      
      const deviceNames = {
        led: 'LED',
        fan: 'Qu·∫°t',
        fog: 'Phun s∆∞∆°ng',
        heater: 'S∆∞·ªüi'
      };
      
      for (const [device, data] of Object.entries(floorData.daily.devices)) {
        html += `
          <div class="energy-item">
            <div class="energy-item-label">${deviceNames[device]}</div>
            <div style="font-size: 12px; color: #666; margin: 5px 0;">
              ${data.runtimeFormatted}<br>
              ${data.powerW}W √ó ${data.runtimeHours}h
            </div>
            <div class="energy-item-value">${data.energyKWh} kWh</div>
            <div style="font-size: 14px; font-weight: bold; color: #28a745;">${data.costFormatted}</div>
          </div>
        `;
      }
      
      html += `</div>`;
      return html;
    }

    function closeEnergyModal() {
      const modal = document.getElementById('energy-modal');
      if (modal) {
        modal.remove();
      }
    }

    async function updateEnergyConfig() {
      const powerLed = document.getElementById('power-led').value;
      const powerFan = document.getElementById('power-fan').value;
      const powerFog = document.getElementById('power-fog').value;
      const powerHeater = document.getElementById('power-heater').value;
      const price = document.getElementById('electricity-price').value;
      
      try {
        await fetch(`${SERVER_URL}/update-power`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device: 'led', power: powerLed })
        });
        
        await fetch(`${SERVER_URL}/update-power`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device: 'fan', power: powerFan })
        });
        
        await fetch(`${SERVER_URL}/update-power`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device: 'fog', power: powerFog })
        });
        
        await fetch(`${SERVER_URL}/update-power`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device: 'heater', power: powerHeater })
        });
        
        await fetch(`${SERVER_URL}/update-price`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ price: price })
        });
        
        alert('‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh th√†nh c√¥ng!');
        
        closeEnergyModal();
        await fetchEnergyReport();
        
      } catch (error) {
        console.error('‚ùå Error updating config:', error);
        alert('‚ùå L·ªói khi l∆∞u c·∫•u h√¨nh!');
      }
    }

    // ==================== H·ªÜ TH·ªêNG CAMERA (UI + STREAM ESP32-CAM) ====================
    function updateCameraData() {
      if (Math.random() > 0.7) {
        cameraData.birdIn += Math.floor(Math.random() * 3) + 1;
      }
      
      if (Math.random() > 0.8) {
        cameraData.birdOut += Math.floor(Math.random() * 2) + 1;
      }
      
      cameraData.countedBirds = cameraData.totalBirds - (cameraData.birdOut - cameraData.birdIn);
      
      if (cameraData.countedBirds < 0) {
        cameraData.countedBirds = 0;
      }
      
      if (Math.random() > 0.95) {
        const newAlert = {
          id: Date.now(),
          type: 'Chim l·∫° ph√°t hi·ªán',
          description: 'Ph√°t hi·ªán chim l·∫° t·∫°i v·ªã tr√≠ ' + Math.floor(Math.random() * 10 + 1),
          time: new Date().toLocaleString('vi-VN'),
          severity: Math.random() > 0.5 ? 'high' : 'medium'
        };
        cameraData.alerts.unshift(newAlert);
        
        if (cameraData.alerts.length > 10) {
          cameraData.alerts.pop();
        }
      }
      
      cameraData.lastUpdate = new Date();
    }

    function adjustTotalBirds(amount) {
      cameraData.totalBirds = Math.max(0, cameraData.totalBirds + amount);
      updateCameraDisplay();
    }

    function setTotalBirds() {
      const input = document.getElementById('total-birds-input');
      const newValue = parseInt(input.value);
      
      if (!isNaN(newValue) && newValue >= 0) {
        cameraData.totalBirds = newValue;
        updateCameraDisplay();
        alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t t·ªïng s·ªë chim: ${newValue} con`);
      } else {
        alert('‚ùå Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá!');
        input.value = cameraData.totalBirds;
      }
    }

    function updateCameraDisplay() {
      cameraData.countedBirds = cameraData.totalBirds - (cameraData.birdOut - cameraData.birdIn);
      
      if (cameraData.countedBirds < 0) {
        cameraData.countedBirds = 0;
      }
      
      const totalBirdsEl = document.getElementById('camera-total-birds');
      const totalBirdsInput = document.getElementById('total-birds-input');
      const birdInEl = document.getElementById('camera-bird-in');
      const birdOutEl = document.getElementById('camera-bird-out');
      const countedBirdsEl = document.getElementById('camera-counted-birds');
      
      if (totalBirdsEl) totalBirdsEl.textContent = cameraData.totalBirds;
      if (totalBirdsInput) totalBirdsInput.value = cameraData.totalBirds;
      if (birdInEl) birdInEl.textContent = cameraData.birdIn;
      if (birdOutEl) birdOutEl.textContent = cameraData.birdOut;
      if (countedBirdsEl) countedBirdsEl.textContent = cameraData.countedBirds;
    }

    function showCameraModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'camera-modal';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px;">
          <div class="modal-header">
            <h2>üìπ H·ªá th·ªëng Camera gi√°m s√°t</h2>
            <button class="modal-close" onclick="closeCameraModal()">√ó</button>
          </div>
          
          <div class="camera-modal-body">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 30%); padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
              <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 150px; text-align: center;">
                  <div style="color: rgba(255,255,255,0.9); font-size: 11px; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;">üè† T·ªïng s·ªë chim nu√¥i</div>
                  <div style="color: white; font-size: 32px; font-weight: 700;" id="camera-total-birds">${cameraData.totalBirds}</div>
                  <div style="color: rgba(255,255,255,0.8); font-size: 10px; margin-top: 3px;">Con</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  <button onclick="adjustTotalBirds(10)" style="width: 38px; height: 38px; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">+</button>
                  <button onclick="adjustTotalBirds(-10)" style="width: 38px; height: 38px; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚àí</button>
                </div>
                <div style="text-align: center;">
                  <input type="number" id="total-birds-input" value="${cameraData.totalBirds}" min="0" style="width: 75px; padding: 7px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 14px; font-weight: bold; text-align: center;" />
                  <button onclick="setTotalBirds()" style="margin-top: 6px; width: 75px; padding: 6px; border-radius: 6px; background: #28a745; color: white; border: none; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">‚úì C·∫≠p nh·∫≠t</button>
                </div>
              </div>
            </div>

            <div class="camera-stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;">
              <div class="camera-stat-card bird-in">
                <div class="camera-stat-icon">üê¶‚û°Ô∏è</div>
                <div class="camera-stat-label">Chim y·∫øn v√†o</div>
                <div class="camera-stat-value" id="camera-bird-in">${cameraData.birdIn}</div>
                <div class="camera-stat-time">H√¥m nay</div>
              </div>
              
              <div class="camera-stat-card bird-out">
                <div class="camera-stat-icon">‚û°Ô∏èüê¶</div>
                <div class="camera-stat-label">Chim y·∫øn ra</div>
                <div class="camera-stat-value" id="camera-bird-out">${cameraData.birdOut}</div>
                <div class="camera-stat-time">H√¥m nay</div>
              </div>
              
              <div class="camera-stat-card counted-birds">
                <div class="camera-stat-icon">üìäüê¶</div>
                <div class="camera-stat-label">Chim t√≠nh ƒë∆∞·ª£c</div>
                <div class="camera-stat-value" id="camera-counted-birds">${cameraData.countedBirds}</div>
                <div class="camera-stat-time">Hi·ªán t·∫°i trong nh√†</div>
              </div>
            </div>
            
            <div class="camera-video-section">
              <h3>üìπ Livestream Camera</h3>
              <div style="margin-bottom: 15px;">
                <!-- Nh√∫ng tr·ª±c ti·∫øp giao di·ªán web c·ªßa ESP32-CAM -->
                <iframe
                  id="camera-iframe"
                  src="${CAMERA_WEB_URL}/"
                  class="camera-video-frame"
                  allowfullscreen
                ></iframe>
              </div>

              <div class="camera-controls">
                <button class="btn-refresh" onclick="reloadCameraStream()">
                  üîÑ L√†m m·ªõi
                </button>
                <button class="btn-export" onclick="openCameraFull()">
                  ‚§¢ M·ªü to√†n m√†n h√¨nh
                </button>
              </div>
            </div>
            
            <div class="camera-alert-section">
              <h3>
                <span>‚ö†Ô∏è</span>
                C·∫£nh b√°o chim l·∫° & ho·∫°t ƒë·ªông b·∫•t th∆∞·ªùng
              </h3>
              
              <div class="camera-alert-list" id="camera-alert-list">
                ${generateAlertListHTML()}
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'block';
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeCameraModal();
        }
      });

      // c·∫≠p nh·∫≠t s·ªë li·ªáu chim l·∫ßn ƒë·∫ßu
      updateCameraDisplay();
    }

    function reloadCameraStream() {
      const iframe = document.getElementById('camera-iframe');
      if (iframe) {
        const oldSrc = iframe.src;
        iframe.src = '';
        setTimeout(() => {
          iframe.src = oldSrc;
        }, 100);
      }
    }

    function openCameraFull() {
      window.open(CAMERA_WEB_URL + '/', '_blank');
    }

    function generateAlertListHTML() {
      if (cameraData.alerts.length === 0) {
        return '<p style="text-align: center; color: #666;">‚úÖ Kh√¥ng c√≥ c·∫£nh b√°o n√†o</p>';
      }
      
      return cameraData.alerts.map(alert => `
        <div class="camera-alert-item">
          <div class="camera-alert-icon">
            ${alert.severity === 'critical' ? 'üö®' : alert.severity === 'high' ? '‚ö†Ô∏è' : '‚ö°'}
          </div>
          <div class="camera-alert-content">
            <div class="camera-alert-title">${alert.type}</div>
            <div class="camera-alert-desc">${alert.description}</div>
            <div class="camera-alert-time">‚è∞ ${alert.time}</div>
          </div>
        </div>
      `).join('');
    }

    function closeCameraModal() {
      const modal = document.getElementById('camera-modal');
      if (modal) {
        modal.remove();
      }
    }

    function refreshCameraData() {
      updateCameraData();
      updateCameraDisplay();
      
      const alertListEl = document.getElementById('camera-alert-list');
      if (alertListEl) {
        alertListEl.innerHTML = generateAlertListHTML();
      }
      
      console.log('üìπ Camera data refreshed:', cameraData);
      
      const cards = document.querySelectorAll('.camera-stat-card');
      cards.forEach(card => {
        card.style.transform = 'scale(1.05)';
        setTimeout(() => {
          card.style.transform = 'scale(1)';
        }, 200);
      });
    }

    // ==================== ƒêI·ªÄU KHI·ªÇN THI·∫æT B·ªä ====================
    function setupDeviceControl(floor) {
      const devices = ['led', 'fan', 'fog', 'heater'];
      
      devices.forEach(device => {
        const btn = document.querySelector(`.toggle-${device}${floor}`);
        if (!btn) return;

        btn.addEventListener('click', () => {
          const isOn = btn.classList.contains('active');
          const newState = isOn ? 'OFF' : 'ON';

          btn.style.opacity = '0.6';
          btn.textContent = '...';

          fetch(`${SERVER_URL}/floor${floor}/${device}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ state: newState })
          })
            .then(res => res.json())
            .then(data => {
              console.log(`‚úÖ Floor ${floor} ${device} response:`, data);
              
              setToggleState(btn, data[device] || newState);
              btn.style.opacity = '1';

              setTimeout(() => {
                fetchData();
                fetchStats();
              }, 200);
            })
            .catch(err => {
              console.error(`‚ùå Floor ${floor} ${device} error:`, err);
              btn.style.opacity = '1';
              setToggleState(btn, isOn ? 'ON' : 'OFF');
              alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server!');
            });
        });
      });
    }

    // ==================== X·ª¨ L√ù MENU HAMBURGER ====================
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const menuDropdown = document.getElementById('menu-dropdown');

    hamburgerBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerBtn.classList.toggle('active');
      menuDropdown.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
      if (!hamburgerBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
        hamburgerBtn.classList.remove('active');
        menuDropdown.classList.remove('show');
      }
    });

    menuDropdown.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        setTimeout(() => {
          hamburgerBtn.classList.remove('active');
          menuDropdown.classList.remove('show');
        }, 200);
      }
    });

    // ==================== X·ª¨ L√ù C√ÅC N√öT CH·ª®C NƒÇNG ====================
    document.getElementById('download-charts').addEventListener('click', () => {
      const startDate = document.getElementById('start-date').value || new Date().toISOString().slice(0,10);
      const [year, month, day] = startDate.split('-');
      const formattedDate = `${day}-${month}-${year}`;
      
      const canvas1 = document.getElementById('chart-floor1');
      const canvas2 = document.getElementById('chart-floor2');
      
      const combinedCanvas = document.createElement('canvas');
      const ctx = combinedCanvas.getContext('2d');
      
      const padding = 30;
      const headerHeight = 80;
      const labelHeight = 40;
      combinedCanvas.width = Math.max(canvas1.width, canvas2.width);
      combinedCanvas.height = canvas1.height + canvas2.height + headerHeight + (padding * 3) + (labelHeight * 2);
      
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
      
      ctx.font = 'bold 28px Arial';
      ctx.fillStyle = '#333333';
      ctx.textAlign = 'center';
      ctx.fillText(`B√°o c√°o ƒë·ªì th·ªã - Ng√†y: ${formattedDate}`, combinedCanvas.width / 2, 40);
      
      const floor1Y = headerHeight + padding;
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'left';
      ctx.fillStyle = '#1976d2';
      ctx.fillText('T·∫ßng 1 - Nhi·ªát ƒë·ªô v√† ƒê·ªô ·∫©m', 20, floor1Y + 5);
      ctx.drawImage(canvas1, 0, floor1Y + labelHeight);
      
      const floor2Y = floor1Y + labelHeight + canvas1.height + padding;
      ctx.fillStyle = '#f57c00';
      ctx.fillText('T·∫ßng 2 - Nhi·ªát ƒë·ªô v√† ƒê·ªô ·∫©m', 20, floor2Y + 5);
      ctx.drawImage(canvas2, 0, floor2Y + labelHeight);
      
      const url = combinedCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = `bao-cao-do-thi-${formattedDate}.png`;
      link.href = url;
      link.click();
      
      console.log('üìä ƒê√£ t·∫£i xu·ªëng bi·ªÉu ƒë·ªì t·ªïng h·ª£p 2 t·∫ßng');
      alert('‚úÖ ƒê√£ t·∫£i xu·ªëng ƒë·ªì th·ªã c·ªßa c·∫£ 2 t·∫ßng!');
    });

    document.getElementById('show-weather-btn').addEventListener('click', () => {
      showWeatherModal();
      fetchWeather();
    });

    document.getElementById('show-energy-btn').addEventListener('click', () => {
      showEnergyDetail();
    });

    document.getElementById('export-excel').addEventListener('click', () => {
      console.log('üì• ƒêang xu·∫•t file Excel...');
      window.open(`${SERVER_URL}/export-excel`, '_blank');
      setTimeout(() => {
        alert('‚úÖ File Excel ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng!');
      }, 1000);
    });

    document.getElementById('show-camera-btn').addEventListener('click', () => {
      showCameraModal();
    });

    // ==================== X·ª¨ L√ù N√öT CHUY·ªÇN T·∫¶NG ====================
    document.querySelectorAll('.floor-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const floor = parseInt(btn.dataset.floor);
        switchFloor(floor);
      });
    });

    // ==================== KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG ====================
    document.getElementById('start-date').valueAsDate = new Date();

    updateDateTime();
    setInterval(updateDateTime, 1000);

    loadHistory(1);
    loadHistory(2);
    fetchData();
    fetchStats();
    fetchEnergyReport();
    fetchWeather();

    setupDeviceControl(1);
    setupDeviceControl(2);

    setInterval(fetchData, POLLING_INTERVAL);
    setInterval(fetchStats, 60000);
    setInterval(fetchEnergyReport, 10000);
    setInterval(fetchWeather, WEATHER_UPDATE_INTERVAL);

    setInterval(() => {
      updateCameraData();
      console.log('üìπ Camera data auto-updated:', cameraData);
    }, 30000);

    setInterval(() => {
      const timeSinceLastUpdate = Date.now() - lastDataCheck;
      if (timeSinceLastUpdate > 10000) {
        console.warn('‚ö†Ô∏è M·∫•t k·∫øt n·ªëi v·ªõi server?');
      }
    }, 5000);

    // Kh·ªüi t·∫°o hi·ªÉn th·ªã T·∫ßng 1
    switchFloor(1);

    console.log('‚úÖ H·ªá th·ªëng ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!');
  </script>
</body>
</html>

